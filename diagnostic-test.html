<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Session Diagnostic Test</title>
    <style>
        body { font-family: monospace; padding: 20px; line-height: 1.5; }
        .log { background: #f0f0f0; padding: 10px; margin: 10px 0; border-left: 4px solid #007acc; }
        .error { border-color: #cc0000; background: #ffe0e0; }
        .success { border-color: #00cc00; background: #e0ffe0; }
        .loading { border-color: #cc7700; background: #fff0e0; }
    </style>
</head>
<body>
    <h1>Session Loading Diagnostic Test</h1>
    <div id="logs"></div>
    <div id="status">Starting diagnostic...</div>

    <script type="module">
        function log(message, type = 'info') {
            const logs = document.getElementById('logs');
            const logDiv = document.createElement('div');
            logDiv.className = `log ${type}`;
            logDiv.innerHTML = `${new Date().toLocaleTimeString()}: ${message}`;
            logs.appendChild(logDiv);
            logs.scrollTop = logs.scrollHeight;
        }

        function setStatus(message, type = 'loading') {
            const status = document.getElementById('status');
            status.innerHTML = `Status: ${message}`;
            status.className = type;
        }

        // Test Supabase connection directly
        import { createClient } from 'https://cdn.skypack.dev/@supabase/supabase-js@2';

        const SUPABASE_URL = 'https://nktdqpzxzouxcsvmijvt.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5rdGRxcHp4em91eGNzdm1panZ0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTcyNzQ0MjMsImV4cCI6MjA3Mjg1MDQyM30.9-wSc9vwUOvWPzQl88mxIT0RwgVDm20GUedP9enI3Jk';

        async function testSupabaseConnection() {
            try {
                log('Creating Supabase client...');
                const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

                log('Testing session fetch...', 'loading');
                setStatus('Testing session fetch...', 'loading');

                const sessionStart = performance.now();
                const { data: { session }, error } = await supabase.auth.getSession();
                const sessionEnd = performance.now();

                if (error) {
                    log(`Session fetch error: ${error.message}`, 'error');
                    setStatus('Session fetch failed', 'error');
                    return;
                }

                log(`Session fetch completed in ${(sessionEnd - sessionStart).toFixed(2)}ms`, 'success');

                if (session) {
                    log(`Found session for user: ${session.user.email}`, 'success');

                    // Test profile fetch
                    log('Testing profile fetch...', 'loading');
                    const profileStart = performance.now();

                    try {
                        const { data: profile, error: profileError } = await supabase
                            .from('profiles')
                            .select('*')
                            .eq('id', session.user.id)
                            .single();

                        const profileEnd = performance.now();

                        if (profileError && profileError.code !== 'PGRST116') {
                            log(`Profile fetch error: ${profileError.message} (${profileError.code})`, 'error');
                        } else if (profile) {
                            log(`Profile fetch completed in ${(profileEnd - profileStart).toFixed(2)}ms`, 'success');
                            log(`Profile data: ${JSON.stringify(profile, null, 2)}`, 'success');
                        } else {
                            log(`No profile found (this is normal for new users)`, 'success');
                        }
                    } catch (profileErr) {
                        log(`Profile fetch failed: ${profileErr.message}`, 'error');
                    }
                } else {
                    log('No active session found', 'success');
                }

                setStatus('Diagnostic complete', 'success');

            } catch (error) {
                log(`Supabase connection error: ${error.message}`, 'error');
                setStatus('Connection failed', 'error');
            }
        }

        // Add timeout test
        setTimeout(() => {
            log('Testing auth state change listener...', 'loading');

            const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
            let listenerFired = false;

            const { data: { subscription } } = supabase.auth.onAuthStateChange((event, session) => {
                listenerFired = true;
                log(`Auth state change: ${event}, session: ${!!session}`, 'success');
            });

            setTimeout(() => {
                if (!listenerFired) {
                    log('Auth state change listener never fired (this could indicate a problem)', 'error');
                }
                subscription.unsubscribe();
            }, 5000);

        }, 1000);

        // Start the diagnostic
        testSupabaseConnection();
    </script>
</body>
</html>